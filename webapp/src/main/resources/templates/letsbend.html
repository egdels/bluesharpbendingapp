<!DOCTYPE html>
<html th:lang="#{language}" th:xmllang="#{language}" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/general :: head}"></head>
<body>
<header th:replace="~{fragments/general :: header}"></header>

<main>
    <div class="container">
        <h2>Let's Bend</h2>
        <div class="select-container">
            <div class="select-group">

            <label for="supportedKeys">Key:</label>
            <select class="form-control" id="supportedKeys" onchange="handleSelectionChange()"
                                                       th:name="supportedKeys">
                <option disabled selected th:if="${harmonica == null}" value="">Bitte w채hlen...</option>
                <option th:each="key : ${supportedKeys}"
                        th:selected="${key == harmonica.getKeyName()}"
                        th:text="${key}"
                        th:value="${key}">
                </option>
            </select>
            </div>
            <div class="select-group">
            <label for="supportedTunes">Tune:</label>
            <select class="form-control" id="supportedTunes" onchange="handleSelectionChange()"
                                                        th:name="supportedTunes">
                <option disabled selected th:if="${harmonica == null}" value="">Bitte w채hlen...</option>
                <option th:each="tune : ${supportedTunes}"
                        th:selected="${tune == harmonica.getTuneName()}"
                        th:text="${tune}"
                        th:value="${tune}">
                </option>
            </select>
            </div>
            <div class="select-group">
            <label for="supportedConcertPitches">Concert Pitch:</label>
            <select class="form-control" id="supportedConcertPitches" onchange="handleSelectionChange()"
                                                                 th:name="supportedConcertPitches">
                <option disabled selected th:if="${selectedConcertPitch == null}" value="">Bitte w채hlen...</option>
                <option th:each="concertPitch : ${supportedConcertPitches}"
                        th:selected="${concertPitch == selectedConcertPitch}"
                        th:text="${concertPitch}"
                        th:value="${concertPitch}">
                </option>
            </select>
            </div>
            <div class="select-group">
            <label for="supportedConfidences">Confidence:</label>
            <select class="form-control" id="supportedConfidences" onchange="handleSelectionChange()"
                    th:name="supportedConfidences">
                <option disabled selected th:if="${selectedConfidence == null}" value="">Bitte w채hlen...</option>
                <option th:each="confidence : ${supportedConfidences}"
                        th:selected="${confidence == selectedConfidence}"
                        th:text="${confidence}"
                        th:value="${confidence}">
                </option>
            </select>
            </div>
        </div>
        <div class="button-container">
            <button id="start">Start</button>
            <button disabled id="stop">Stop</button>
        </div>
        <div id="resultHarmonica" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd;">
            <p th:if="${harmonica != null}">
                Key: <span  id="harmonicaKey"
                            th:text="${harmonica.getKeyName()}"></span> <br />
                Tune: <span id="harmonicaTune"
                            th:text="${harmonica.getTuneName()}"></span>
            </p>
            <p th:if="${harmonica == null}">
                Keine Harmonica in der Session vorhanden.
            </p>
        </div>
        <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd;">
            Ergebnis wird hier angezeigt...
        </div>
        <div th:replace="fragments/harmonica-grid :: harmonicaGrid"></div>
    </div>
</main>

<footer th:replace="~{fragments/general :: footer}"></footer>

<script th:inline="javascript" type="module">
    import PitchDetectionUtil from './scripts/PitchDetectionUtil.js';
    import NoteLookup from './scripts/NoteLookup.js';
    import NoteUtils from './scripts/NoteUtils.js';



    let confidence = 0.7;

    let concertPitch = 442;

    let resultDiv;

    let mediaStream;
    let audioContext;
    let processorNode;

    /**
     * Initializes the WebSocket and audio processing once the DOM content is fully loaded.
     * Also sets up the event handlers for start and stop buttons.
     */
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.line').forEach(line => line.style.visibility = 'hidden');

        resultDiv = document.getElementById('result'); // The <div> where results will be displayed

        // Start button event handler
        document.getElementById('start').addEventListener('click', async () => {
            // Disable the start button and enable the stop button
            document.getElementById('start').disabled = true;
            document.getElementById('stop').disabled = false;

            // Set selected Concert Pitch
            concertPitch = document.getElementById('supportedConcertPitches').value;
            console.log("Concert Pitch: " + concertPitch);

            NoteLookup.concertPitch=concertPitch;

            confidence = document.getElementById('supportedConfidences').value;
            console.log("Selected Confidence: " + confidence);

            try {
                // Request microphone access
                mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});
                const audioContext = new AudioContext();
                console.log(audioContext.sampleRate);


                // Create an audio source from the media stream
                const source = audioContext.createMediaStreamSource(mediaStream);

                // Set up audio processor
                processorNode = audioContext.createScriptProcessor(4096, 1, 1);
                source.connect(processorNode);
                processorNode.connect(audioContext.destination);

                // Process audio data in real time and send it to the server
                processorNode.onaudioprocess = (e) => {
                    const audioData = e.inputBuffer.getChannelData(0); // Channel 0 (mono data)

                    const result = PitchDetectionUtil.detectPitchWithYIN(audioData, audioContext.sampleRate);
                    const noteName = NoteLookup.getNoteName(result.pitch);
                    if(noteName) {
                        const noteFrequency = NoteLookup.getFrequency(noteName);
                        const cents = NoteUtils.getCents(noteFrequency, result.pitch);
                        const data = {
                            noteName: noteName,
                            cents: cents,
                            confidence: result.confidence,
                        };
                        resultDiv.innerHTML = "noteName: " + noteName + ", cents: " + cents + ", confidence: " + result.confidence;
                        handleChange(data, confidence);
                    }

                };

            } catch (err) {
                console.error("Error accessing the microphone:", err);
                resultDiv.style.visibility = 'visible';
                resultDiv.style.display = 'block';
                resultDiv.style.backgroundColor = 'red';
                resultDiv.innerHTML = "Error accessing the microphone: " + err.message;
                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
            }
        });

        // Stop button event handler
        document.getElementById('stop').addEventListener('click', () => {
            // Stop audio processing and close the stream
            if (processorNode) processorNode.disconnect();
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }

            console.log("Streaming stopped");
            resultDiv.innerHTML = "Streaming stopped.";

            // Reset UI
            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
        });
    });
</script>
</body>
</html>